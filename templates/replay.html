{% extends "base.html" %}
{% block content %}
<h2 class="text-2xl font-semibold mb-4">Comparative Overlay Replay</h2>

<div class="bg-gray-800 p-6 rounded shadow">
  <canvas id="overlayChart" class="w-full h-96"></canvas>
</div>

<script>
const ctx = document.getElementById('overlayChart');


// Trades passed from FastAPI, each trade.timeline includes {stage, detail, anomaly, testimony_link}
const trades = {{ trades|tojson | safe }};

const icons = {
  "Signal": "üî•",
  "Council Vote": "üìú",
  "Execution": "‚öñÔ∏è",
  "Outcome": "üëë"
};

const colors = ['#f59e0b','#6366f1','#10b981','#ef4444','#8b5cf6'];

const datasets = trades.map((trade, idx) => {
  const labels = trade.timeline.map(s => s.stage);
  const details = trade.timeline.map(s => s.detail);
  const anomalies = trade.timeline.map(s => s.anomaly);
  const testimonyLinks = trade.timeline.map(s => s.testimony_link);

  return {
    label: `Trade ${trade.trade_id}`,
    data: labels.map((_, i) => i+1),
    borderColor: colors[idx % colors.length],
    backgroundColor: colors[idx % colors.length],
    stepped: true,
    pointRadius: 10,
    pointStyle: labels.map((l, i) => {
      if (anomalies[i]) {
        return { render: 'label', label: "‚ùå" };
      }
      return { render: 'label', label: icons[l] || "‚Ä¢" };
    }),
    customDetails: details,
    customLinks: testimonyLinks
  };
});

new Chart(ctx, {
  type: 'line',
  data: { labels: ["Signal","Council Vote","Execution","Outcome"], datasets },
  options: {
    animation: { duration: 2500, easing: 'easeInOutQuart' },
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            const ds = context.dataset;
            let msg = ds.label + ": " + ds.customDetails[context.dataIndex];
            const link = ds.customLinks[context.dataIndex];
            if (link) {
              msg += " (Testimony: " + link + ")";
            }
            return msg;
          }
        }
      }
    },
    scales: { y: { display: false } }
  }
});
</script>
{% endblock %}
